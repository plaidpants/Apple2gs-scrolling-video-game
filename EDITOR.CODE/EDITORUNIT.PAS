unit CreateUnit;interfaceuses	QDIntf,	GSIntf,	MiscTools,	ConsoleIO,	Prodos16,	FontMgr,	ListMgr,	PrintMgr;const		ScreenMode=$00;	MaxX=320;	AppleMenu=300;	AboutItem=301;		FileMenu=400;	LoadEverythingItem=403;	ScaleUpItem=401;	ScaleDownItem=402;	SaveItem=405;	LoadItem=404;	AnalItem=406;	LearnItem=415;	CreateItem=407;	PageSetUpItem=410;	ChooserItem=411;	PrintItem=412;	QuitItem=408;		EditMenu=500;	UndoItem=501;	CutItem=503;	CopyItem=504;	PasteItem=505;	ClearItem=506;		WindowMenu=600;	TerrainItem=602;	ShapeItem=603;	EditorItem=604;	CycleItem=605;type	BlockType=packed array [0..254,0..255] of byte;	myCursor=		record			CursorHeight,			CursorWidth:Integer;			data,			mask:array[1..11,1..2] of longint;			hotSpot:Point;		end;		var		MemoryID:Integer;	ToolsZeroPage:Handle;	Done:Boolean;		AppleMenuStr,	FileMenuStr,	WindowMenuStr,	EditMenuStr:str255;	MenuHeight:integer;	TypeList:TypeListRec;	myReply:ReplyRecord;	P16Blk:P16ParamBlk;	EditorWindPtr,	ShapeWindPtr,	TerrainWindPtr:WindowPtr;	ShapeOffscreenPort:GrafPtr;	ShapeOffscreenLocInfo:LocInfoRec;	ShapeOffscreenHandle:Handle;	ShapePort:GrafPtr;	ShapeLocInfo:LocInfoRec;	ShapeHandle:Handle;	GridPort:GrafPtr;	GridLocInfo:LocInfoRec;	GridHandle:Handle;	TempPort:GrafPtr;	TempLocInfo:LocInfoRec;	TempHandle:Handle;	Colors:array [0..15] of colorTable;	LastColorCycle:longint;	ColorCycleSpeed,	colorSetNumber:integer;	CrossCursor:myCursor;		Scale:longint;	TheCursor,	PaletteColorNumber,	ShapeWindowShapeNumber,	Tool,	BrushSize,	GridOption,	CopyShapeNumber,	SelectPatternNumber:integer;	SelectRect,	CopyRect:Rect;	CycleOption:boolean;	SelectPatterns:array [0..15] of Pattern;	PrintHdl:THPrint;{$DSeg one}	Terrain:BlockType;{$DSeg two}	LeftRight:BlockType;{$DSeg three}	UpDown:BlockType;{$DSeg ~global}procedure StartUpGSTools;procedure ShutDownGSTools;Procedure SetUpMenus;Procedure SetUpGridScreen;Procedure SetUpTempPort;Procedure UpdateEditorInfo(infoBar:rect;		infoData:LongInt;		TheWindow:WindowPtr);Procedure UpdateEditorWindow;Procedure SetUpEditorWindow;Procedure SetUpShapeOffScreen;Procedure UpdateShapeOffscreen;Procedure UpdateShapeWindow;Procedure SetUpShapeWindow;Procedure SetUpTerrainOffScreen;Procedure UpdateTerrainWindow;Procedure UpdateTerrainInfo(infoBar:rect;		infoData:LongInt;		TheWindow:WindowPtr);Procedure SetUpTerrainWindow;implementationprocedure specialrect(theRect:Rect;FrameColor,FillColor:integer);	tool 18,12;	procedure StartUpGSTools;var		ToolRec:ToolTable;	svToolErrorNum,	btn:integer;	begin	TLStartUp;	MemoryID:=MMStartUp;	MTStartUp;	ToolsZeroPage:=NewHandle(12*$100,MemoryID,FixedBank+PageAligned+Fixedblk+Locked,ptr(0));	QDStartUp(LoWord(ToolsZeroPage^),ScreenMode,160,MemoryID);		MoveTo(40,40);	SetBackColor(0);	SetForeColor(15);	DrawString('One moment please...');		with toolrec do		begin			NumTools:=14;			Tools[1].TSNum:=4;			Tools[1].MinVersion:=1;			Tools[2].TSNum:=5;			Tools[2].MinVersion:=1;			Tools[3].TSNum:=6;			Tools[3].MinVersion:=1;			Tools[4].TSNum:=14;			Tools[4].MinVersion:=0;			Tools[5].TSNum:=15;			Tools[5].MinVersion:=1;			Tools[6].TSNum:=16;			Tools[6].MinVersion:=1;			Tools[7].TSNum:=21;			Tools[7].MinVersion:=0;			Tools[8].TSNum:=20;			Tools[8].MinVersion:=0;			Tools[9].TSNum:=22;			Tools[9].MinVersion:=0;			Tools[10].TSNum:=23;			Tools[10].MinVersion:=0;			Tools[11].TSNum:=18;			Tools[11].MinVersion:=0;			Tools[12].TSNum:=27;			Tools[12].MinVersion:=0;			Tools[13].TSNum:=28;			Tools[13].MinVersion:=0;			Tools[14].TSNum:=19;			Tools[14].MinVersion:=0;		end;			repeat		LoadTools(ToolRec);		svToolErrorNum:=ToolErrorNum;		if svToolErrorNum <> 0 then 			begin				btn:=TLMountVolume(100,40,'Error loading tools','Insert System Disk','Ok','Cancel');				if btn <> 1 then						SysFailMgr(svToolErrorNum,'Unable to load tools');			end;	until svToolErrorNum = 0;   	QDAuxStartUp;	EMStartUp(LoWord(ToolsZeroPage^)+$300,20,0,MaxX,0,200,MemoryID);  WindStartUp(MemoryID);		RefreshDesktop(nil);	CtlStartUp(MemoryID,LoWord(ToolsZeroPage^)+$400);	MenuStartUp(MemoryID,LoWord(ToolsZeroPage^)+$500);	LEStartUp(MemoryID,LoWord(ToolsZeroPage^)+$600);	DialogStartUp(MemoryID);  ScrapStartUp;	DeskStartUp;  SFStartUp(MemoryID,LoWord(ToolsZeroPage^)+$700);	ListStartUp;	FMStartUp(MemoryID,LoWord(ToolsZeroPage^)+$800);	PMStartUp(MemoryID,LoWord(ToolsZeroPage^)+$900);		Printhdl:=THPrint(NewHandle(140,memoryID,noBankCross,Ptr(0)));		PRDefault(Printhdl);end;procedure ShutDownGSTools;	begin		GrafOff;		DeskShutDown;		PMShutDown;		FMShutDown;		ListShutDown;		SFShutDown;		DialogShutDown;		LEShutDown;		ScrapShutDown;		MenuShutDown;		WindShutDown;		CtlShutDown;		EMShutDown;		QDAuxShutDown;		QDShutDown;		MTShutDown;		MMShutDown(MemoryID);		TLShutDown;	end;		Procedure SetUpMenus;			begin		AppleMenuStr:=ConCat(	'>>@\XN300\0',													'==About Shape Editor...\N301\0',													'==-\N302D\0..');															FileMenuStr:=ConCat(	'>>  File  \N400\0',													'==Open...\N404\0',													'==Open all...\N403\0',													'==Save As...\N405\0',													'==-\N502D\0',													'==Page Setup\N410\0',													'==Chooser\N411\0',													'==Print\N412\0',																										'==-\N502D\0',													'==Quit\N408*Qq\0.');															EditMenuStr:=ConCat(	'>>  Edit  \N500\0',													'==Undo\N501*Zz\0',													'==-\N502D\0',													'==Cut\N503*Xx\0',													'==Copy\N504*Cc\0',													'==Paste\N505*Vv\0',													'==Clear\N506\0',													'==-\N502D\0',													'==Learn\N415\0',													'==Analyze\N406\0',													'==Create\N407\0.');														WindowMenuStr:=ConCat('>>  Window  \N600\0',													'==Terrain\N602*Tt\0',													'==Shape\N603*Ss\0',													'==Editor\N604*Ee\0',													'==-\N502D\0',													'==Scale up\N402\0',													'==Scale Down\N401\0',													'==-\N502D\0',													'==Cycle Colors\N605\0');		SetMTitleStart(10);				InsertMenu(NewMenu(@WindowMenuStr[1]),0);		InsertMenu(NewMenu(@EditMenuStr[1]),0);		InsertMenu(NewMenu(@FileMenuStr[1]),0);		InsertMenu(NewMenu(@AppleMenuStr[1]),0);				FixAppleMenu(AppleMenu);		MenuHeight:=FixMenuBar;		DrawMenuBar;	end;Procedure SetUpGridScreen;		var		i:integer;			begin	  GridHandle:=NewHandle(16*32*4*4,MemoryID,SpecialMem+PageAligned+Fixedblk+Locked,nil);		GridLocInfo.PortSCB:=$00;		GridLocInfo.PixelImage:=ptr(GridHandle^);		GridLocInfo.width:=16*4;		SetRect(GridLocInfo.BoundsRect,0,0,32*4,32*4);				New(GridPort);		OpenPort(GridPort);		SetPortLoc(GridLocInfo);		SetPortRect(GridLocInfo.BoundsRect);		ClipRect(GridLocInfo.BoundsRect);		GetClip(GridPort^.VisRgn);		EraseRect(GridPort^.PortRect);		SetSolidPenPat(0);		for i:=0 to 31 do			begin				moveto(0,i*4);				lineto(128,i*4);				moveto(i*4,0);				lineto(i*4,128);			end;	end;Procedure SetUpTempPort;		begin	  TempHandle:=NewHandle(16*32,MemoryID,SpecialMem+PageAligned+Fixedblk+Locked,nil);		TempLocInfo.PortSCB:=$00;		TempLocInfo.PixelImage:=ptr(TempHandle^);		TempLocInfo.width:=16;		SetRect(TempLocInfo.BoundsRect,0,0,32,32);				New(TempPort);		OpenPort(TempPort);		SetPortLoc(TempLocInfo);		SetPortRect(TempLocInfo.BoundsRect);		ClipRect(TempLocInfo.BoundsRect);		GetClip(TempPort^.VisRgn);		EraseRect(TempPort^.PortRect);	end;	{$LongGlobals+}Procedure UpdateEditorInfo(infoBar:rect;		infoData:LongInt;		TheWindow:WindowPtr);		var		ColorRect:Rect;		i:integer;			begin		SetRect(ColorRect,infoBar.left,infoBar.top,infoBar.left+8,infoBar.top+8);		for i:=0 to 15 do			begin				SetSolidPenPat(i);				PaintRect(ColorRect);				if i=PaletteColorNumber then					begin						setSolidPenPat(15-i);						FrameRect(ColorRect);					end;				OffsetRect(ColorRect,8,0);			end;		SetRect(ColorRect,infoBar.left,infoBar.top+8,infoBar.left+16,infoBar.top+24);		SetSolidPenPat(0);		for i:=0 to 3 do			begin				if i=BrushSize div 2 then					SpecialRect(ColorRect,0,0)				else					SpecialRect(ColorRect,0,$FFFF);				OffsetRect(ColorRect,16,0);			end;		for i:=0 to 3 do			begin				if i=GridOption then					SpecialRect(ColorRect,0,0)				else					SpecialRect(ColorRect,0,$FFFF);				OffsetRect(ColorRect,16,0);			end;	end;Procedure UpdateEditorWindow;		var		ShapeRect:Rect;		i:integer;			begin		SetRect(ShapeRect,0,0,32,32);		OffsetRect(ShapeRect,0,32*ShapeWindowShapeNumber);		CopyPixels(ShapePort^.PortInfo,EditorWindPtr^.PortInfo,ShapeRect,EditorWindPtr^.portrect,SrcCopy,EditorWindPtr^.VisRgn);		case GridOption of		1:PPtoPort(GridPort^.PortInfo,GridPort^.PortRect,0,0,notSrcBic);		2:PPtoPort(GridPort^.PortInfo,GridPort^.PortRect,0,0,notSrcOr);		3:PPtoPort(GridPort^.PortInfo,GridPort^.PortRect,0,0,notSrcXOr);		end;	end;{$LongGlobals-}var	EditorWindTitle:str255;	EditorWind:newWindowParamBlk;Procedure SetUpEditorWindow;		begin		EditorWindTitle:='Editor';		With EditorWind do			begin				param_length:=Sizeof(NewWindowParamBlk);				Wframe:=$C0F0;				WTitle:=@EditorWindTitle;				wRefCon:=0;				SetRect(wZoom,0,0,128,128);				OffsetRect(wZoom,50,40);				wColor:=nil;				wYOrigin:=0;				wXOrigin:=0;				wDataH:=128;				wDataW:=128;				wMaxH:=128;				wMaxW:=128;				wScrollver:=0;				wScrollHor:=0;				wPageVer:=0;				wPageHor:=0;				wInfoRefCon:=0;				wInfoHeight:=24;				wFrameDefProc:=nil;				wInfoDefProc:=@UpdateEditorInfo;				wContDefProc:=@UpdateEditorWindow;				wPosition:=wZoom;				wPlane:=-1;				wStorage:=nil;			end;		EditorWindPtr:=NewWindow(EditorWind);	end;Procedure SetUpShapeOffScreen;			begin		ShapeHandle:=NewHandle(16*32*256,MemoryID,SpecialMem+PageAligned+Fixedblk+Locked,nil);		ShapeLocInfo.PortSCB:=$00;		ShapeLocInfo.PixelImage:=ptr(ShapeHandle^);		ShapeLocInfo.width:=16;		SetRect(ShapeLocInfo.BoundsRect,0,0,32,8192);				New(ShapePort);		OpenPort(ShapePort);		SetPortLoc(ShapeLocInfo);		SetPortRect(ShapeLocInfo.BoundsRect);		ClipRect(ShapeLocInfo.BoundsRect);		GetClip(ShapePort^.VisRgn);		EraseRect(ShapePort^.PortRect);	  ShapeOffscreenHandle:=NewHandle(32*32*16*16 div 2,MemoryID,SpecialMem+PageAligned+Fixedblk+Locked,nil);		ShapeOffscreenLocInfo.PortSCB:=$00;		ShapeOffscreenLocInfo.PixelImage:=ptr(ShapeOffscreenHandle^);		ShapeOffscreenLocInfo.width:=(32*16) div 2;		SetRect(ShapeOffscreenLocInfo.BoundsRect,0,0,32*16,32*16);				New(ShapeOffscreenPort);		OpenPort(ShapeOffscreenPort);		SetPortLoc(ShapeOffscreenLocInfo);		SetPortRect(ShapeOffscreenLocInfo.BoundsRect);		ClipRect(ShapeOffscreenLocInfo.BoundsRect);		GetClip(ShapeOffscreenPort^.VisRgn);		EraseRect(ShapeOffscreenPort^.PortRect);	end;Procedure UpdateShapeOffscreen;	var		ShapeRect,		TempRect1,		TempRect2,		DestRect:Rect;		i,j:integer;			begin		SetPort(ShapeOffscreenPort);		EraseRect(ShapeOffscreenPort^.PortRect);		SetRect(ShapeRect,0,0,32,32);		SetRect(DestRect,0,0,Scale,Scale);					for i:=0 to 15 do			for j:=0 to 15 do				begin					TempRect1:=ShapeRect;					TempRect2:=DestRect;					OffsetRect(TempRect1,0,32*(i*16+j));					OffsetRect(TempRect2,i*Scale,j*Scale);					CopyPixels(ShapePort^.PortInfo,ShapeOffscreenPort^.PortInfo,TempRect1,TempRect2,SrcCopy,ShapeOffscreenPort^.VisRgn);				end;	end;{$LongGlobals+}Procedure UpdateShapeWindow;		var		destRect:Rect;			begin		PPtoPort(ShapeOffscreenPort^.PortInfo,ShapeOffscreenPort^.PortRect,0,0,SrcCopy);		SetRect(DestRect,0,0,Scale,Scale);		offsetRect(DestRect,ShapeWindowShapeNumber div 16 * Scale,ShapeWindowShapeNumber mod 16 * Scale);		Setsolidpenpat(15);		SetPenMode(SrcXor);		FrameRect(DestRect);	end;{$LongGlobals-}var	ShapeWindTitle:str255;	ShapeWind:newWindowParamBlk;Procedure SetUpShapeWindow;		begin		ShapeWindTitle:='Shape';		With ShapeWind do			begin				param_length:=Sizeof(NewWindowParamBlk);				Wframe:=$DCA8;				WTitle:=@ShapeWindTitle;				wRefCon:=0;				SetRect(wZoom,0,0,64,160);				offsetRect(wZoom,0,32);				wColor:=nil;				wYOrigin:=0;				wXOrigin:=0;				wDataH:=Scale*16;				wDataW:=Scale*16;				wMaxH:=200;				wMaxW:=320;				wScrollver:=Scale;				wScrollHor:=Scale;				wPageVer:=Scale*4;				wPageHor:=Scale*4;				wInfoRefCon:=0;				wInfoHeight:=0;				wFrameDefProc:=nil;				wInfoDefProc:=nil;				wContDefProc:=@UpdateShapeWindow;				wPosition:=wZoom;				wPlane:=-1;				wStorage:=nil;			end;		ShapeWindPtr:=NewWindow(ShapeWind);	end;Procedure SetUpTerrainOffScreen;		var		i,j:integer;			begin		for i:=0 to 255 do			for j:=0 to 255 do				begin						LeftRight[i,j]:=0;					updown[i,j]:=0;					Terrain[i,j]:=0;				end;		for i:=0 to 255 do			begin					LeftRight[0,i]:=0;				updown[0,i]:=0;				LeftRight[i,0]:=0;				updown[i,0]:=0;			end;	end;{$LongGlobals+}Procedure UpdateTerrainWindow;		var		ShapeRect,		TempRect,		DestRect,		PortRect:Rect;		i,j,RightSide,BottomSide:integer;		theport:WindowPtr;			begin		thePort:=GetPort;		portRect:=thePort^.portInfo.boundsRect;		SetRect(ShapeRect,0,0,scale,scale);		RightSide:=PortRect.right div Scale +1;		if RightSide>255 then			RightSide:=255;		BottomSide:=PortRect.bottom div Scale +1 ;		if BottomSide>255 then			BottomSide:=255;					for i:=PortRect.left div Scale to RightSide do			for j:=PortRect.top div Scale to BottomSide do				begin					TempRect:=ShapeRect;					OffsetRect(TempRect,terrain[j,i] div 16 *scale,terrain[j,i] mod 16 *scale);					PPtoPort(ShapeOffscreenPort^.PortInfo,TempRect,i*scale,j*scale,SrcCopy);				end;	end;Procedure UpdateTerrainInfo(infoBar:rect;		infoData:LongInt;		TheWindow:WindowPtr);		var		ToolRect:Rect;		i:integer;			begin		SetRect(ToolRect,infoBar.left,infoBar.top,infoBar.left+16,infoBar.bottom);		setSolidPenPat(0);		for i:=0 to 5 do			begin				if i=tool then					SpecialRect(ToolRect,0,0)				else					SpecialRect(ToolRect,0,$FFFF);				OffsetRect(ToolRect,16,0);			end;	end;{$LongGlobals-}var	TerrainWindTitle:str255;	TerrainWind:newWindowParamBlk;Procedure SetUpTerrainWindow;		begin		TerrainWindTitle:='Terrain';		With TerrainWind do			begin				param_length:=Sizeof(NewWindowParamBlk);				Wframe:=$DDF8;				WTitle:=@TerrainWindTitle;				wRefCon:=0;				SetRect(wZoom,0,0,8*32,32*5);				offsetRect(wZoom,45,40);				wColor:=nil;				wYOrigin:=0;				wXOrigin:=0;				wDataH:=256*Scale;				wDataW:=256*Scale;				wMaxH:=200;				wMaxW:=320;				wScrollver:=Scale;				wScrollHor:=Scale;				wPageVer:=Scale*4;				wPageHor:=Scale*4;				wInfoRefCon:=0;				wInfoHeight:=16;				wFrameDefProc:=nil;				wInfoDefProc:=@UpdateTerrainInfo;				wContDefProc:=@UpdateTerrainWindow;				SetRect(wPosition,0,0,128,128);				offsetRect(wPosition,185,40);				wPlane:=-1;				wStorage:=nil;			end;		TerrainWindPtr:=NewWindow(TerrainWind);	end;end.